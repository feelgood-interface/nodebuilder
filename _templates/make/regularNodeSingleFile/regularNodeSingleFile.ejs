---
to: src/output/<%= helpers.pascalCase(metaParams.serviceName) %>.node.ts
---
<%_ builders.constructor(mainParams, metaParams); _%>
import {
	IExecuteFunctions,
} from 'n8n-core';

import {
	INodeExecutionData,
	INodeType,
	INodeTypeDescription,
	IDataObject,
} from 'n8n-workflow';

import {
	<%= builders.buildServiceApiRequest() %>,
} from './GenericFunctions';

export class <%= helpers.pascalCase(metaParams.serviceName) %> implements INodeType {
	description: INodeTypeDescription = {
		displayName: '<%= metaParams.serviceName %>',
		name: '<%= helpers.camelCase(metaParams.serviceName) %>',
		icon: 'file:<%= helpers.camelCase(metaParams.serviceName) %>.png',
		group: ['transform'],
		version: 1,
		subtitle: '={{$parameter["operation"] + ": " + $parameter["resource"]}}',
		description: 'Consume <%= metaParams.serviceName %> API',
		defaults: {
			name: '<%= metaParams.serviceName %>',
			color: '<%= metaParams.nodeColor %>',
		},
		inputs: ['main'],
		outputs: ['main'],
		properties: [
			<%= builders.buildHeader("Resources") %>
			{
				displayName: 'Resource',
				name: 'resource',
				type: 'options',
				options: [
					<%_ builders.getResourceNames().forEach((resourceName) => { _%>
					{
						name: '<%= helpers.titleCase(resourceName) %>',
						value: '<%= helpers.camelCase(resourceName) %>',
					},
					<%_ }); _%><%#_ end resourceNames loop _%>
				],
				default: '<%= builders.getResourceNames()[0].toLowerCase() %>',
				description: 'Resource to consume',
			},
			<%= builders.buildHeader("Operations") %>
			<%_ builders.getResourceTuples().forEach(([resourceName, operationsArray]) => { _%>
			{
				displayName: 'Operation',
				name: 'operation',
				type: 'options',
				displayOptions: {
					show: {
						resource: [
							'<%= resourceName.toLowerCase() %>',
						],
					},
				},
				options: [
					<%_ operationsArray.forEach(operation => { _%>
					{
						name: '<%= helpers.pascalCase(operation.operationId) %>',
						value: '<%= helpers.camelCase(operation.operationId) %>',
						description: '<%- helpers.escape(operation.description) %>',
					},
					<%_ }); _%><%#_ end operations loop _%>
				],
				default: '<%= helpers.camelCase(operationsArray[0].operationId) %>',
				description: 'Operation to perform',
			},
			<%_ }); _%><%#_ end resourceTuples loop _%>
			<%= builders.buildHeader("Fields") %>
			<%_ builders.getResourceTuples().forEach(([resourceName, operationsArray]) => { _%>
      <%_ operationsArray.forEach(operation => { _%>
			<%_/**
			 * **********************
			 * PARAMETERS
			 * **********************
			 */_%>
			<%_ if (operation.parameters) { _%>
			<%_ operation.parameters.forEach(parameter => { _%>
			{
				displayName: '<%= helpers.titleCase(parameter.name) %>',
				name: '<%= helpers.camelCase(parameter.name) %>',
				description: '<%= parameter.description %>',
				type: '<%= helpers.adjustType(parameter.schema.type) %>',
				<%_ if (helpers.hasMinMax(parameter.schema)) { _%>
				typeOptions: {
					minValue: <%= parameter.schema.minimum %>,
					maxValue: <%= parameter.schema.maximum %>
				},
				<%_ } _%>
				required: true,
				default: <%- helpers.getDefault(parameter.schema) %>,
				displayOptions: {
					show: {
						resource: [
							'<%= helpers.camelCase(resourceName) %>',
						],
						operation: [
							'<%= helpers.camelCase(operation.operationId) %>',
						],
					},
				},
			},
      <%_ }); _%> <%#_ end parameters loop _%>
      <%_ } _%> <%#_ end parameters if _%>
			<%_/**
			 * **********************
			 * REQUEST BODY
			 * **********************
       */_%>
      <%_ if (operation.requestBody) { _%>
      <%_ operation.requestBody.forEach(requestBody => { _%>
      <%_ Object.keys(requestBody.content).forEach((mimeType) => { _%>
      <%_ if (mimeType === "text/plain") { _%>
      {
        displayName: 'Text',
        name: 'text',
        description: '<%= requestBody.description %>',
        required: true,
        default: '',
				displayOptions: {
					show: {
						resource: [
							'<%= helpers.camelCase(resourceName) %>',
						],
						operation: [
							'<%= helpers.camelCase(operation.operationId) %>',
						],
					},
				},
      },
      <%_ } else if (mimeType === "application/x-www-form-urlencoded") { _%>
      <%_ const schema = requestBody.content[mimeType].schema; _%>
      <%_ Object.keys(schema.properties).forEach((propertyName) => { _%>
      <%_ const property = schema.properties[propertyName]; _%>
      {
        displayName: '<%= helpers.titleCase(propertyName) %>',
        name: '<%= helpers.camelCase(propertyName) %>',
        <%_ if (property.description) { _%>
        description: '<%- helpers.escape(property.description) %>',
        <%_ } _%>
        type: '<%= helpers.adjustType(property.type) %>',
        <%_ if (helpers.hasMinMax(property)) { _%>
        typeOptions: {
          minValue: <%= property.minimum %>,
          maxValue: <%= property.maximum %>
        },
        <%_ } _%>
        required: true,
        default: <%- helpers.getDefault(property) %>,
        displayOptions: {
          show: {
            resource: [
              '<%= helpers.camelCase(resourceName) %>',
            ],
            operation: [
              '<%= helpers.camelCase(operation.operationId) %>',
            ],
          },
        },
      },
      <%_ }); _%> <%#_ end properties loop _%>
      <%_ } _%> <%#_ end mimeType if _%>
      <%_ }); _%> <%#_ end mimeTypeObj loop _%>
      <%_ }); _%> <%#_ end requestBody loop _%>
      <%_ } _%> <%#_ end requestBody if _%>
			<%_/**
			 * **********************
			 * ADDITIONAL FIELDS
			 * **********************
			 */_%>
      <%_ if (operation.additionalFields) { _%>
      {
        displayName: 'Additional Fields',
        name: 'additionalFields',
        type: 'collection',
        default: {},
        displayOptions: {
          show: {
            resource: [
              '<%= helpers.camelCase(resourceName) %>',
            ],
            operation: [
              '<%= helpers.camelCase(operation.operationId) %>',
            ],
          },
        },
        options: [
        <%_ operation.additionalFields.options.forEach(option => { _%>
          {
            name: '<%= option.name %>',
            <%_ if (option.description) { _%>
            description: '<%- helpers.escape(option.description) %>',
            <%_ } _%>
            type: '<%= helpers.adjustType(option.type) %>',
            default: <%- helpers.getDefault(option) %>,
					},
        <%_ }); _%> <%#_ end options loop _%>
        ]
      },
			<%_ } _%> <%#_ end additionalFields if _%>
	<%_ }); _%> <%#_ end operations loop _%>
	<%_ }); _%> <%#_ end resourceTuples loop _%>
		], <%# end properties key of object at description class field %>
	}; <%# end description class field %>

	async execute(this: IExecuteFunctions): Promise<INodeExecutionData[][]> {
		const items = this.getInputData();
		const returnData: IDataObject[] = [];

		const resource = this.getNodeParameter('resource', 0) as string;
		const operation = this.getNodeParameter('operation', 0) as string;
		const qs: IDataObject = {};

		let responseData: any;

		for (let i = 0; i < items.length; i++) {

			<%_ builders.getResourceTuples().forEach(([resourceName, operationsArray]) => { _%>
			<%- builders.buildResourceBranch(resourceName) %>

			<%_ operationsArray.forEach(operation => { _%>
				<%= builders.buildDivider(helpers.camelCase(resourceName), operation.operationId); %>

				<%- builders.buildOperationBranch(operation, resourceName) %>
				<%_ const requestMethod = operation.requestMethod.toUpperCase(); _%>
					<%_/**
					* **********************
					* PARAMETERS
					* **********************
					*/_%>
					<%_ if (operation.parameters) { _%>
					<%_/**
					 * ------ Path Parameters ------
					 * */_%>
					<%_ if (helpers.hasPathParams(operation.endpoint)) { _%>
					<% const pathParams = helpers.getParams(operation.parameters, "path"); %>
					<%_ pathParams.forEach(pathParam => { _%>
					const <%= pathParam %> = this.getNodeParameter('<%= pathParam %>', i);
					<%_ }); _%>
					const endpoint = `<%= helpers.toTemplateLiteral(operation.endpoint) _%>`;
					responseData = await <%= builders.buildServiceApiRequest() %>.call(this, '<%= requestMethod %>', endpoint, {}, {});
					<%_/**
					 * ------ Query Parameters ------
					 * */_%>
					<%_ } else { _%>

					<%_ const queryParams = helpers.getParams(operation.parameters, "query"); _%>
					<%_ queryParams.forEach(queryParam => { _%>
					qs.<%= queryParam %> = this.getNodeParameter('<%= queryParam %>', i);
					<%_ }); _%>

					<%_ if (operation.additionalFields) { _%>
					const additionalFields = this.getNodeParameter('additionalFields', i) as IDataObject;
					<%_ operation.additionalFields.options.forEach(option => { _%>

					if (additionalFields.<%= option.name %>) {
					<%_ if (option.in === 'query') { _%>
						qs.<%= option.name %> = this.getNodeParameter('<%= option.name %>', i);
					}
					<%_ } _%>
					<%_ }); _%>
					<%_ } _%>

					const endpoint = '<%= operation.endpoint %>';
					responseData = await <%= builders.buildServiceApiRequest() %>.call(this, '<%= requestMethod %>', endpoint, qs, {});
					<%_ } _%>
					<%_/**
					* **********************
					* REQUEST BODY
					* **********************
					*/_%>
					<%_ } else if (operation.requestBody) { _%>

					const body: IDataObject = {};
					const endpoint = '<%= operation.endpoint %>';
					responseData = await <%= builders.buildServiceApiRequest() %>.call(this, '<%= requestMethod %>', endpoint, {}, body);
					<%_/**
					* **************************************************
					* NO PATH PARAMS OR QUERY PARAMS OR REQUEST BODY
					* **************************************************
					*/_%>
					<%_ } else { _%>

					const endpoint = '<%= operation.endpoint %>';
					responseData = await <%= builders.buildServiceApiRequest() %>.call(this, '<%= requestMethod %>', endpoint, {}, {});
					<%_ } _%>
				<%= builders.buildOperationError(operation, resourceName) _%>

			<%_ }); _%> <%#_ end operationsArray loop _%>
			<%_ if (helpers.isLast(resourceName, builders.getResourceNames())) { _%>
			} else {
				throw new Error(`Unknown resource: ${resource}`);
			}
			<%_ } _%>
			<%_ }); _%> <%#_ end resourceTuples loop _%>

			Array.isArray(responseData)
				? returnData.push(...responseData)
				: returnData.push(responseData);

		}

		return [this.helpers.returnJsonArray(returnData)];
	}
} <%# end class %>